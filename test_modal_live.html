<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Test Modal Live</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@4.6.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@4.6.0/dist/js/bootstrap.bundle.min.js"></script>
</head>
<body>
    <div class="container mt-5">
        <h1>Test Modal Live - Con Petición Real</h1>
        
        <div class="alert alert-info">
            <strong>Test del endpoint real</strong><br>
            Este test hará peticiones reales al servidor Django en http://127.0.0.1:8000
        </div>
        
        <!-- Simular el login status -->
        <div id="loginStatus" class="alert alert-warning">
            <strong>Estado de Login:</strong> <span id="statusText">Verificando...</span>
        </div>
        
        <!-- Simular botón de cambio con datos reales -->
        <button type="button" class="btn btn-warning change-question-btn"
                data-student-question-id="1369"
                data-group-id="81" 
                data-current-question-id="21">
            <i class="fas fa-exchange-alt"></i> Cambiar Pregunta (Datos Reales)
        </button>
        
        <!-- Test directo del endpoint -->
        <div class="mt-3">
            <button type="button" class="btn btn-info" onclick="testEndpointDirectly()">
                Test Endpoint Directamente
            </button>
        </div>
        
        <!-- Logs -->
        <div class="mt-4">
            <h3>Logs de Actividad:</h3>
            <div id="logOutput" class="border p-3" style="height: 300px; overflow-y: auto; background-color: #f8f9fa;">
            </div>
        </div>
        
        <div class="mt-3">
            <button type="button" class="btn btn-secondary" onclick="clearLogs()">
                Clear Logs
            </button>
        </div>
    </div>

    <!-- Modal exacto del template original -->
    <div class="modal fade" id="changeQuestionModal" tabindex="-1" role="dialog" aria-labelledby="changeQuestionModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-lg" role="document">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="changeQuestionModalLabel">
                        <i class="fas fa-exchange-alt"></i> Cambiar Pregunta
                    </h5>
                    <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                        <span aria-hidden="true">&times;</span>
                    </button>
                </div>
                <div class="modal-body">
                    <div class="alert alert-info">
                        <i class="fas fa-info-circle"></i>
                        Seleccione una pregunta de reemplazo. Solo se mostrarán preguntas disponibles que no hayan sido utilizadas en este grupo.
                    </div>
                    
                    <div id="availableQuestionsContainer">
                        <!-- Se llena dinámicamente -->
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-dismiss="modal">
                        <i class="fas fa-times"></i> Cancelar
                    </button>
                    <button type="button" class="btn btn-primary" id="confirmExchangeBtn" disabled>
                        <i class="fas fa-check"></i> Confirmar Cambio
                    </button>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Override console para mostrar logs
        const originalLog = console.log;
        const originalError = console.error;
        
        function addToLog(message, type = 'log') {
            const logOutput = document.getElementById('logOutput');
            const timestamp = new Date().toLocaleTimeString();
            const color = type === 'error' ? 'text-danger' : type === 'warn' ? 'text-warning' : 'text-dark';
            logOutput.innerHTML += `<div class="${color}">[${timestamp}] ${message}</div>`;
            logOutput.scrollTop = logOutput.scrollHeight;
        }
        
        console.log = function(...args) {
            originalLog.apply(console, args);
            addToLog(args.join(' '));
        };
        
        console.error = function(...args) {
            originalError.apply(console, args);
            addToLog('ERROR: ' + args.join(' '), 'error');
        };

        // Variables globales
        let currentStudentQuestionId = null;
        let selectedNewQuestionId = null;
        
        // URLs del servidor Django real
        const URLS = {
            getAvailableQuestions: 'http://127.0.0.1:8000/oral-exams/available-questions/',
            exchangeQuestion: 'http://127.0.0.1:8000/oral-exams/exchange-question/'
        };
        
        function clearLogs() {
            document.getElementById('logOutput').innerHTML = '';
        }
        
        // Test del endpoint directo
        function testEndpointDirectly() {
            console.log('Testing endpoint directly...');
            
            const url = URLS.getAvailableQuestions + '?' + 
                        'group_id=81&current_question_id=21';
            
            console.log('Fetching URL:', url);
            
            fetch(url, {
                method: 'GET',
                credentials: 'same-origin'  // Incluir cookies de session
            })
            .then(response => {
                console.log('Response status:', response.status);
                console.log('Response headers:', [...response.headers.entries()]);
                return response.json();
            })
            .then(data => {
                console.log('Response data:', data);
                if (data.success) {
                    addToLog(`SUCCESS: Found ${data.count} questions`);
                    if (data.available_questions && data.available_questions.length > 0) {
                        data.available_questions.forEach(q => {
                            addToLog(`  - ${q.question_text} (${q.topic_name})`);
                        });
                    }
                } else {
                    addToLog(`ERROR: ${data.error}`, 'error');
                }
            })
            .catch(error => {
                console.error('Fetch error:', error);
                addToLog(`FETCH ERROR: ${error.message}`, 'error');
            });
        }
        
        // Verificar estado de login
        function checkLoginStatus() {
            fetch('http://127.0.0.1:8000/', {
                credentials: 'same-origin'
            })
            .then(response => {
                if (response.ok) {
                    document.getElementById('statusText').textContent = 'Posiblemente logueado';
                    document.getElementById('loginStatus').className = 'alert alert-success';
                } else {
                    document.getElementById('statusText').textContent = 'Posiblemente NO logueado';
                    document.getElementById('loginStatus').className = 'alert alert-danger';
                }
            })
            .catch(error => {
                document.getElementById('statusText').textContent = 'Error al verificar';
                document.getElementById('loginStatus').className = 'alert alert-danger';
            });
        }
        
        // Función principal del modal (copiada del template)
        function openChangeQuestionModal(btn) {
            console.log('openChangeQuestionModal called');
            
            currentStudentQuestionId = btn.getAttribute('data-student-question-id');
            const groupId = btn.getAttribute('data-group-id');
            const currentQuestionId = btn.getAttribute('data-current-question-id');
            
            console.log('Modal data:', {
                currentStudentQuestionId,
                groupId,
                currentQuestionId
            });
            
            if (!currentStudentQuestionId || !groupId || !currentQuestionId) {
                console.error('Missing data attributes');
                return;
            }
            
            // Reset modal
            selectedNewQuestionId = null;
            const confirmBtn = document.getElementById('confirmExchangeBtn');
            if (confirmBtn) {
                confirmBtn.disabled = true;
            }
            
            // Load questions
            loadAvailableQuestions(groupId, currentQuestionId);
            
            // Show modal
            $('#changeQuestionModal').modal('show');
        }
        
        function loadAvailableQuestions(groupId, currentQuestionId) {
            console.log('Loading available questions...');
            
            const container = document.getElementById('availableQuestionsContainer');
            container.innerHTML = '<div class="text-center"><div class="spinner-border"></div><p>Cargando...</p></div>';
            
            const url = URLS.getAvailableQuestions + '?' + 
                        `group_id=${groupId}&current_question_id=${currentQuestionId}`;
            
            fetch(url, {
                credentials: 'same-origin'
            })
            .then(response => response.json())
            .then(data => {
                console.log('Questions loaded:', data);
                if (data.success) {
                    displayAvailableQuestions(data.available_questions);
                } else {
                    container.innerHTML = `<div class="alert alert-danger">Error: ${data.error}</div>`;
                }
            })
            .catch(error => {
                console.error('Load error:', error);
                container.innerHTML = `<div class="alert alert-danger">Error de conexión: ${error.message}</div>`;
            });
        }
        
        function displayAvailableQuestions(questions) {
            const container = document.getElementById('availableQuestionsContainer');
            
            if (!questions || questions.length === 0) {
                container.innerHTML = '<div class="alert alert-warning">No hay preguntas disponibles</div>';
                return;
            }
            
            let html = '<div class="list-group">';
            questions.forEach(question => {
                html += `
                    <label class="list-group-item list-group-item-action">
                        <input type="radio" name="newQuestionRadio" value="${question.id}">
                        <strong>${question.question_text}</strong>
                        <small class="text-muted d-block">${question.topic_name} | ${question.difficulty}</small>
                    </label>
                `;
            });
            html += '</div>';
            
            container.innerHTML = html;
        }
        
        // Event listeners
        document.addEventListener('DOMContentLoaded', function() {
            console.log('DOM loaded');
            
            // Check login status
            checkLoginStatus();
            
            // Event listener para botón cambiar
            document.addEventListener('click', function(e) {
                if (e.target.classList.contains('change-question-btn')) {
                    console.log('Change button clicked!');
                    openChangeQuestionModal(e.target);
                }
            });
            
            // Event listener para selección
            document.addEventListener('change', function(e) {
                if (e.target.name === 'newQuestionRadio') {
                    selectedNewQuestionId = e.target.value;
                    console.log('Selected question:', selectedNewQuestionId);
                    document.getElementById('confirmExchangeBtn').disabled = false;
                }
            });
        });
    </script>
</body>
</html>
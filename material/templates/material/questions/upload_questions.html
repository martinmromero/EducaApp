{% extends 'material/base.html' %}
{% load static %}

{% block content %}
<div class="container {% if dark_mode %}bg-dark text-light{% else %}bg-light{% endif %}" style="min-height: 100vh; padding: 20px;">
    <h1 class="{% if dark_mode %}text-light{% else %}text-dark{% endif %}">Subir Preguntas</h1>

    <!-- Mensajes -->
    {% if messages %}
        {% for message in messages %}
            <div class="alert {% if message.tags == 'error' %}alert-danger{% else %}alert-success{% endif %}">
                {{ message }}
            </div>
        {% endfor %}
    {% endif %}

    <!-- Pestañas -->
    <ul class="nav nav-tabs mb-4" id="uploadTabs" role="tablist">
        <li class="nav-item">
            <a class="nav-link active" id="single-tab" data-toggle="tab" href="#single" role="tab">Individual</a>
        </li>
        <li class="nav-item">
            <a class="nav-link" id="batch-tab" data-toggle="tab" href="#batch" role="tab">Lote (CSV/TXT)</a>
        </li>
    </ul>

    <!-- Contenido de pestañas -->
    <div class="tab-content">
        <!-- Pestaña Individual -->
        <div class="tab-pane fade show active" id="single" role="tabpanel">
            <form method="post" enctype="multipart/form-data" id="singleForm">
                {% csrf_token %}
                <div class="form-group">
                    <label for="{{ form.subject.id_for_label }}">Materia</label>
                    <div class="input-group">
                        {{ form.subject }}
                        <div class="input-group-append">
                            <button class="btn btn-outline-secondary" type="button" data-toggle="modal" data-target="#newTopicModal">
                                <i class="fas fa-plus"></i> Nuevo Tema
                            </button>
                        </div>
                    </div>
                </div>

                <div class="row">
                    <div class="col-md-6">
                        <div class="form-group">
                            <label for="{{ form.topic.id_for_label }}">Tema Principal</label>
                            <div class="input-group">
                                {{ form.topic }}
                                <div class="input-group-append">
                                    <button class="btn btn-outline-primary" type="button" id="addTopicBtn">
                                        <i class="fas fa-plus"></i>
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-6">
                        <div class="form-group">
                            <label for="{{ form.subtopic.id_for_label }}">Subtema</label>
                            <div class="input-group">
                                {{ form.subtopic }}
                                <div class="input-group-append">
                                    <button class="btn btn-outline-primary" type="button" id="addSubtopicBtn">
                                        <i class="fas fa-plus"></i>
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="form-group">
                    <label for="{{ form.question_text.id_for_label }}">Pregunta</label>
                    {{ form.question_text }}
                </div>

                <div class="form-group">
                    <label for="{{ form.question_image.id_for_label }}">Imagen de Pregunta</label>
                    {{ form.question_image }}
                    <div id="questionImagePreview" class="mt-2" style="max-width: 300px;"></div>
                </div>

                <div class="form-group">
                    <label for="{{ form.answer_text.id_for_label }}">Respuesta</label>
                    {{ form.answer_text }}
                </div>

                <div class="form-group">
                    <label for="{{ form.answer_image.id_for_label }}">Imagen de Respuesta</label>
                    {{ form.answer_image }}
                    <div id="answerImagePreview" class="mt-2" style="max-width: 300px;"></div>
                </div>

                <div class="row">
                    <div class="col-md-8">
                        <div class="form-group">
                            <label for="{{ form.contenido.id_for_label }}">Contenido/Referencia</label>
                            {{ form.contenido }}
                        </div>
                    </div>
                    <div class="col-md-4">
                        <div class="form-group">
                            <label for="{{ form.source_page.id_for_label }}">Página</label>
                            {{ form.source_page }}
                        </div>
                    </div>
                </div>

                <button type="submit" class="btn btn-primary">Guardar Pregunta</button>
            </form>
        </div>

        <!-- Pestaña Lote -->
        <div class="tab-pane fade" id="batch" role="tabpanel">
            <form method="post" enctype="multipart/form-data" id="batchForm">
                {% csrf_token %}
                <div class="form-group">
                    <label for="batchFile">Subir Archivo</label>
                    <input type="file" class="form-control-file" id="batchFile" name="file" accept=".csv,.txt">
                    <small class="form-text text-muted">Formatos soportados: CSV o TXT</small>
                </div>

                <div class="mt-3">
                    <h5>Plantillas de Ejemplo:</h5>
                    <div class="btn-group">
                        <a href="{% url 'material:download_template' format='csv' %}" class="btn btn-outline-secondary">Descargar CSV</a>
                        <a href="{% url 'material:download_template' format='txt' %}" class="btn btn-outline-secondary">Descargar TXT</a>
                    </div>
                </div>

                <button type="submit" class="btn btn-primary mt-3">Subir Archivo</button>
            </form>
        </div>
    </div>

    <!-- Modal para nuevo Tema -->
    <div class="modal fade" id="newTopicModal" tabindex="-1" role="dialog" aria-labelledby="newTopicModalLabel" aria-hidden="true">
        <div class="modal-dialog" role="document">
            <div class="modal-content {% if dark_mode %}bg-dark text-light{% else %}bg-light{% endif %}">
                <div class="modal-header">
                    <h5 class="modal-title" id="newTopicModalLabel">Agregar Nuevo Tema</h5>
                    <button type="button" class="close {% if dark_mode %}text-light{% else %}text-dark{% endif %}" data-dismiss="modal" aria-label="Close">
                        <span aria-hidden="true">&times;</span>
                    </button>
                </div>
                <div class="modal-body">
                    <form id="newTopicForm">
                        <div class="form-group">
                            <label for="newTopicName">Nombre del Tema</label>
                            <input type="text" class="form-control {% if dark_mode %}bg-secondary text-light{% else %}bg-white{% endif %}" id="newTopicName" required>
                        </div>
                        <div class="form-group">
                            <label for="newTopicSubject">Materia</label>
                            <select class="form-control {% if dark_mode %}bg-secondary text-light{% else %}bg-white{% endif %}" id="newTopicSubject" required>
                                <option value="">Seleccione una materia</option>
                                {% for subject in form.subject.field.queryset %}
                                    <option value="{{ subject.id }}">{{ subject.name }}</option>
                                {% endfor %}
                            </select>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-dismiss="modal">Cancelar</button>
                    <button type="button" class="btn btn-primary" id="saveNewTopic">Guardar</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal para nuevo Subtema -->
    <div class="modal fade" id="newSubtopicModal" tabindex="-1" role="dialog" aria-labelledby="newSubtopicModalLabel" aria-hidden="true">
        <div class="modal-dialog" role="document">
            <div class="modal-content {% if dark_mode %}bg-dark text-light{% else %}bg-light{% endif %}">
                <div class="modal-header">
                    <h5 class="modal-title" id="newSubtopicModalLabel">Agregar Nuevo Subtema</h5>
                    <button type="button" class="close {% if dark_mode %}text-light{% else %}text-dark{% endif %}" data-dismiss="modal" aria-label="Close">
                        <span aria-hidden="true">&times;</span>
                    </button>
                </div>
                <div class="modal-body">
                    <form id="newSubtopicForm">
                        <div class="form-group">
                            <label for="newSubtopicName">Nombre del Subtema</label>
                            <input type="text" class="form-control {% if dark_mode %}bg-secondary text-light{% else %}bg-white{% endif %}" id="newSubtopicName" required>
                        </div>
                        <div class="form-group">
                            <label for="newSubtopicTopic">Tema Principal</label>
                            <select class="form-control {% if dark_mode %}bg-secondary text-light{% else %}bg-white{% endif %}" id="newSubtopicTopic" required>
                                <option value="">Seleccione un tema primero</option>
                            </select>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-dismiss="modal">Cancelar</button>
                    <button type="button" class="btn btn-primary" id="saveNewSubtopic">Guardar</button>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Scripts -->
<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

<script>
$(document).ready(function() {
    // Previsualización de imágenes
    function handleImagePreview(input, previewId) {
        if (input.files && input.files[0]) {
            const reader = new FileReader();
            reader.onload = function(e) {
                $(previewId).html(`<img src="${e.target.result}" class="img-fluid rounded border">`);
            }
            reader.readAsDataURL(input.files[0]);
        } else {
            $(previewId).html('');
        }
    }

    $('#{{ form.question_image.id_for_label }}').change(function() {
        handleImagePreview(this, '#questionImagePreview');
    });

    $('#{{ form.answer_image.id_for_label }}').change(function() {
        handleImagePreview(this, '#answerImagePreview');
    });

    // Dinámica de topic/subtopic
    function loadTopics(subjectId, selectedTopicId = null) {
        if (!subjectId) {
            $('#{{ form.topic.id_for_label }}')
                .html('<option value="">Seleccione una materia primero</option>')
                .prop('disabled', true);
            return;
        }

        $.ajax({
            url: '{% url "material:get_topics" %}',
            data: { 'subject_id': subjectId },
            success: function(data) {
                let options = '<option value="">Seleccione un tema</option>';
                data.forEach(function(topic) {
                    const selected = topic.id == selectedTopicId ? 'selected' : '';
                    options += `<option value="${topic.id}" ${selected}>${topic.name}</option>`;
                });
                
                $('#{{ form.topic.id_for_label }}')
                    .html(options)
                    .prop('disabled', false);
                
                if (selectedTopicId) {
                    loadSubtopics(selectedTopicId);
                } else if (data.length === 1) {
                    // Seleccionar automáticamente si solo hay un tema
                    $('#{{ form.topic.id_for_label }}').val(data[0].id).trigger('change');
                }
            },
            error: function() {
                Swal.fire({
                    icon: 'error',
                    title: 'Error',
                    text: 'No se pudieron cargar los temas'
                });
            }
        });
    }

    function loadSubtopics(topicId, selectedSubtopicId = null) {
        if (!topicId) {
            $('#{{ form.subtopic.id_for_label }}')
                .html('<option value="">Seleccione un tema primero</option>')
                .prop('disabled', true);
            return;
        }

        $.ajax({
            url: '{% url "material:get_subtopics" %}',
            data: { 'topic_id': topicId },
            success: function(data) {
                let options = '<option value="">Sin subtema</option>';
                data.forEach(function(subtopic) {
                    const selected = subtopic.id == selectedSubtopicId ? 'selected' : '';
                    options += `<option value="${subtopic.id}" ${selected}>${subtopic.name}</option>`;
                });
                
                $('#{{ form.subtopic.id_for_label }}')
                    .html(options)
                    .prop('disabled', false);
            },
            error: function() {
                Swal.fire({
                    icon: 'error',
                    title: 'Error',
                    text: 'No se pudieron cargar los subtemas'
                });
            }
        });
    }

    // Eventos de cambio
    $('#{{ form.subject.id_for_label }}').change(function() {
        loadTopics($(this).val());
    });

    $('#{{ form.topic.id_for_label }}').change(function() {
        loadSubtopics($(this).val());
    });

    // Inicialización
    function initializeSelects() {
        const subjectId = $('#{{ form.subject.id_for_label }}').val();
        const topicId = $('#{{ form.topic.id_for_label }}').val();
        
        if (subjectId) {
            loadTopics(subjectId, topicId);
        }
    }
    initializeSelects();

    // Manejo de modales
    $('#addTopicBtn').click(function() {
        const subjectId = $('#{{ form.subject.id_for_label }}').val();
        if (!subjectId) {
            Swal.fire({
                icon: 'warning',
                title: 'Seleccione una materia primero',
                text: 'Debe seleccionar una materia antes de agregar un nuevo tema'
            });
            return;
        }
        $('#newTopicName').val('');
        $('#newTopicSubject').val(subjectId);
        $('#newTopicModal').modal('show');
    });

    $('#addSubtopicBtn').click(function() {
        const topicId = $('#{{ form.topic.id_for_label }}').val();
        if (!topicId) {
            Swal.fire({
                icon: 'warning',
                title: 'Seleccione un tema primero',
                text: 'Debe seleccionar un tema antes de agregar un nuevo subtema'
            });
            return;
        }
        
        $('#newSubtopicName').val('');
        $('#newSubtopicTopic').val(topicId);
        $('#newSubtopicModal').modal('show');
    });

    // Guardar nuevo Tema
    $('#saveNewTopic').click(function() {
        const name = $('#newTopicName').val().trim();
        const subjectId = $('#newTopicSubject').val();
        
        if (!name) {
            Swal.fire({
                icon: 'error',
                title: 'Nombre requerido',
                text: 'Debe ingresar un nombre para el tema'
            });
            return;
        }

        $.ajax({
            url: '{% url "material:add_topic" %}',
            method: 'POST',
            data: {
                'name': name,
                'subject_id': subjectId,
                'csrfmiddlewaretoken': '{{ csrf_token }}'
            },
            contentType: 'application/x-www-form-urlencoded; charset=UTF-8',
            dataType: 'json',
            success: function(response) {
                if (response.success) {
                    // Actualizar select de temas
                    $('#{{ form.topic.id_for_label }}').append(
                        $('<option>', {
                            value: response.topic.id,
                            text: response.topic.name,
                            selected: true
                        })
                    ).trigger('change');
                    
                    Swal.fire({
                        icon: 'success',
                        title: '¡Éxito!',
                        text: 'Tema creado correctamente'
                    });
                    
                    $('#newTopicModal').modal('hide');
                } else {
                    Swal.fire({
                        icon: 'error',
                        title: 'Error',
                        text: response.error || 'Error al crear el tema'
                    });
                }
            },
            error: function(xhr) {
                let errorMsg = 'Error al comunicarse con el servidor';
                if (xhr.responseJSON && xhr.responseJSON.error) {
                    errorMsg = xhr.responseJSON.error;
                }
                Swal.fire({
                    icon: 'error',
                    title: 'Error',
                    text: errorMsg
                });
            }
        });
    });

    // Guardar nuevo Subtema
    $('#saveNewSubtopic').click(function() {
        const name = $('#newSubtopicName').val().trim();
        const topicId = $('#newSubtopicTopic').val();
        
        if (!name) {
            Swal.fire({
                icon: 'error',
                title: 'Nombre requerido',
                text: 'Debe ingresar un nombre para el subtema'
            });
            return;
        }

        $.ajax({
            url: '{% url "material:add_subtopic" %}',
            method: 'POST',
            data: {
                'name': name,
                'topic_id': topicId,
                'csrfmiddlewaretoken': '{{ csrf_token }}'
            },
            contentType: 'application/x-www-form-urlencoded; charset=UTF-8',
            dataType: 'json',
            success: function(response) {
                if (response.success) {
                    // Actualizar select de subtemas
                    $('#{{ form.subtopic.id_for_label }}').append(
                        $('<option>', {
                            value: response.subtopic.id,
                            text: response.subtopic.name,
                            selected: true
                        })
                    ).trigger('change');
                    
                    Swal.fire({
                        icon: 'success',
                        title: '¡Éxito!',
                        text: 'Subtema creado correctamente'
                    });
                    
                    $('#newSubtopicModal').modal('hide');
                } else {
                    Swal.fire({
                        icon: 'error',
                        title: 'Error',
                        text: response.error || 'Error al crear el subtema'
                    });
                }
            },
            error: function(xhr) {
                let errorMsg = 'Error al comunicarse con el servidor';
                if (xhr.responseJSON && xhr.responseJSON.error) {
                    errorMsg = xhr.responseJSON.error;
                }
                Swal.fire({
                    icon: 'error',
                    title: 'Error',
                    text: errorMsg
                });
            }
        });
    });

    // Cambiar pestañas
    $('a[data-toggle="tab"]').on('shown.bs.tab', function(e) {
        localStorage.setItem('lastTab', $(e.target).attr('id'));
    });

    const lastTab = localStorage.getItem('lastTab');
    if (lastTab) {
        $(`#${lastTab}`).tab('show');
    }
});
</script>

<style>
    .nav-tabs .nav-link {
        color: {% if dark_mode %}#ffffff{% else %}#495057{% endif %};
        background-color: {% if dark_mode %}#343a40{% else %}#f8f9fa{% endif %};
    }
    .nav-tabs .nav-link.active {
        color: {% if dark_mode %}#000000{% else %}#495057{% endif %};
        background-color: {% if dark_mode %}#f8f9fa{% else %}#ffffff{% endif %};
    }
    
    .input-group-append .btn {
        border-radius: 0 .25rem .25rem 0;
    }
    
    #questionImagePreview img, 
    #answerImagePreview img {
        max-height: 200px;
        object-fit: contain;
    }
</style>
{% endblock %}
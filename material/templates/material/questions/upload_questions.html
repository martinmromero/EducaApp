<script>
document.addEventListener('DOMContentLoaded', function() {
    // Mostrar input de nuevo tema
    const topicSelect = document.getElementById('id_topic');
    const newTopicInput = document.getElementById('newTopicInput');
    if (topicSelect && newTopicInput) {
        topicSelect.addEventListener('change', function() {
            if (this.value === '__new__') {
                newTopicInput.style.display = '';
            } else {
                newTopicInput.style.display = 'none';
            }
        });
        // Ocultar al inicio
        newTopicInput.style.display = 'none';
    }

    // Mostrar input de nuevo subtema
    const subtopicSelect = document.getElementById('id_subtopic');
    const newSubtopicInput = document.getElementById('newSubtopicInput');
    if (subtopicSelect && newSubtopicInput) {
        subtopicSelect.addEventListener('change', function() {
            if (this.value === '__new__') {
                newSubtopicInput.style.display = '';
            } else {
                newSubtopicInput.style.display = 'none';
            }
        });
        // Ocultar al inicio
        newSubtopicInput.style.display = 'none';
    }
});
</script>
{% extends 'material/base.html' %}
{% load static %}

{% block content %}
<div class="container {% if dark_mode %}bg-dark text-light{% else %}bg-light{% endif %}" style="min-height: 100vh; padding: 20px;">
    <h1 class="{% if dark_mode %}text-light{% else %}text-dark{% endif %}">Subir Preguntas</h1>

    <!-- Mensajes -->
    {% if messages %}
        {% for message in messages %}
            <div class="alert {% if message.tags == 'error' %}alert-danger{% else %}alert-success{% endif %}">
                {{ message }}
            </div>
        {% endfor %}
    {% endif %}

    <!-- Pestañas -->
    <ul class="nav nav-tabs mb-4" id="uploadTabs" role="tablist">
        <li class="nav-item">
            <a class="nav-link {% if current_tab == 'single' %}active{% endif %}" id="single-tab" data-bs-toggle="tab" href="#single" role="tab">Individual</a>
        </li>
        <li class="nav-item">
            <a class="nav-link {% if current_tab == 'batch' %}active{% endif %}" id="batch-tab" data-bs-toggle="tab" href="#batch" role="tab">Lote (CSV/TXT)</a>
        </li>
    </ul>

    <!-- Contenido de pestañas -->
    <div class="tab-content">
        <!-- Pestaña Individual -->
        <div class="tab-pane fade {% if current_tab == 'single' %}show active{% endif %}" id="single" role="tabpanel">
            <form method="post" enctype="multipart/form-data" id="singleForm">
                {% csrf_token %}
                <div class="form-group">
                    <label for="{{ form.subject.id_for_label }}">Materia</label>
                    <div class="input-group">
                        {{ form.subject }}
                    </div>
                </div>

                <div class="row">
                    <div class="col-md-6">
                        <div class="form-group">
                            <label for="{{ form.topic.id_for_label }}">Tema Principal</label>
                            <div class="input-combo d-flex align-items-center gap-2">
                                <select name="topic" id="id_topic" class="form-control"></select>
                                <button type="button" class="btn btn-sm btn-outline-secondary dynamic-add-btn" id="addTopicBtn" data-target="topic" data-field="id_topic">
                                    <i class="fas fa-plus"></i> Nuevo
                                </button>
                            </div>
                            <div class="input-combo mt-2" id="newTopicContainer" style="display:none;">
                                <input type="text" class="form-control dynamic-input" id="new_topic" placeholder="Nombre del tema">
                                <button type="button" class="btn btn-sm btn-success" id="saveNewTopic">Guardar</button>
                                <button type="button" class="btn btn-sm btn-secondary" id="cancelNewTopic">Cancelar</button>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-6">
                        <div class="form-group">
                            <label for="{{ form.subtopic.id_for_label }}">Subtema</label>
                            <div class="input-combo d-flex align-items-center gap-2">
                                <select name="subtopic" id="id_subtopic" class="form-control"></select>
                                <button type="button" class="btn btn-sm btn-outline-secondary dynamic-add-btn" id="addSubtopicBtn" data-target="subtopic" data-field="id_subtopic">
                                    <i class="fas fa-plus"></i> Nuevo
                                </button>
                            </div>
                            <div class="input-combo mt-2" id="newSubtopicContainer" style="display:none;">
                                <input type="text" class="form-control dynamic-input" id="new_subtopic" placeholder="Nombre del subtema">
                                <button type="button" class="btn btn-sm btn-success" id="saveNewSubtopic">Guardar</button>
                                <button type="button" class="btn btn-sm btn-secondary" id="cancelNewSubtopic">Cancelar</button>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="form-group">
                    <label for="{{ form.question_text.id_for_label }}">Pregunta</label>
                    {{ form.question_text }}
                </div>

                <div class="form-group">
                    <label for="{{ form.question_image.id_for_label }}">Imagen de Pregunta</label>
                    {{ form.question_image }}
                    <div id="questionImagePreview" class="mt-2" style="max-width: 300px;"></div>
                </div>

                <div class="form-group">
                    <label for="{{ form.answer_text.id_for_label }}">Respuesta</label>
                    {{ form.answer_text }}
                </div>

                <div class="form-group">
                    <label for="{{ form.answer_image.id_for_label }}">Imagen de Respuesta</label>
                    {{ form.answer_image }}
                    <div id="answerImagePreview" class="mt-2" style="max-width: 300px;"></div>
                </div>

                <div class="row">
                    <div class="col-md-8">
                        <div class="form-group">
                            <label for="{{ form.contenido.id_for_label }}">Contenido/Referencia</label>
                            {{ form.contenido }}
                        </div>
                    </div>
                    <div class="col-md-4">
                        <div class="form-group">
                            <label for="{{ form.source_page.id_for_label }}">Página</label>
                            {{ form.source_page }}
                        </div>
                    </div>
                </div>

                <button type="submit" class="btn btn-primary">Guardar Pregunta</button>
            </form>
        </div>

    <!-- Pestaña Lote -->
    <div class="tab-pane fade {% if current_tab == 'batch' %}show active{% endif %}" id="batch" role="tabpanel">
<script>
// Guardar y restaurar la última pestaña activa usando localStorage
document.addEventListener('DOMContentLoaded', function() {
    var triggerTabList = [].slice.call(document.querySelectorAll('#uploadTabs a'));
    triggerTabList.forEach(function(triggerEl) {
        triggerEl.addEventListener('shown.bs.tab', function (event) {
            localStorage.setItem('uploadQuestionsTab', event.target.id === 'batch-tab' ? 'batch' : 'single');
        });
    });
    // Restaurar pestaña activa
    var lastTab = localStorage.getItem('uploadQuestionsTab');
    if (lastTab && document.getElementById(lastTab + '-tab')) {
        var tab = new bootstrap.Tab(document.getElementById(lastTab + '-tab'));
        tab.show();
    }
});
</script>
            <form method="post" enctype="multipart/form-data" id="batchForm">
                {% csrf_token %}

                <div class="form-group">
                    <label for="batchFile">Subir Archivo</label>
                    <input type="file" class="form-control-file" id="batchFile" name="file" accept=".csv,.txt">
                    <small class="form-text text-muted">Formatos soportados: CSV o TXT</small>
                </div>

                <div class="alert alert-info mt-3">
                    <strong>Formato esperado para CSV:</strong><br>
                    <code>materia,pregunta,respuesta,tema,subtema,unidad,libro_referencia,pagina,capitulo</code><br>
                    Ejemplo:<br>
                    <code>Matemáticas,¿Cuánto es 2+2?,4,Álgebra,,1,Libro de Álgebra,12,Capítulo 1</code><br>
                    <code>Historia,¿Quién fue San Martín?,Libertador,Independencia,Argentina,2,Libro de Historia,34,Capítulo 2</code>
                    <br><br>
                    <strong>Formato esperado para TXT:</strong><br>
                    <pre style="white-space: pre-line;">
materia: Matemáticas
pregunta: ¿Cuánto es 2+2?
respuesta: 4
tema: Álgebra
unidad: 1
libro_referencia: Libro de Álgebra
pagina: 12
capitulo: Capítulo 1

materia: Historia
pregunta: ¿Quién fue San Martín?
respuesta: Libertador
tema: Independencia
subtema: Argentina
unidad: 2
libro_referencia: Libro de Historia
pagina: 34
capitulo: Capítulo 2
                    </pre>
                    <a href="/static/material/ejemplo_batch_preguntas.csv" class="btn btn-outline-secondary btn-sm mt-2" download>Descargar ejemplo CSV</a>
                    <a href="/static/material/ejemplo_batch_preguntas.txt" class="btn btn-outline-secondary btn-sm mt-2 ms-2" download>Descargar ejemplo TXT</a>
                </div>

                <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
                <script>
                $(document).ready(function() {
                    // Previsualización de imágenes
                    function handleImagePreview(input, previewId) {
                        if (input.files && input.files[0]) {
                            const reader = new FileReader();
                            reader.onload = function(e) {
                                $(previewId).html(`<img src="${e.target.result}" class="img-fluid rounded border">`);
                            }
                            reader.readAsDataURL(input.files[0]);
                        } else {
                            $(previewId).html('');
                        }
                    }
                    $('#{{ form.question_image.id_for_label }}').change(function() {
                        handleImagePreview(this, '#questionImagePreview');
                    });
                    $('#{{ form.answer_image.id_for_label }}').change(function() {
                        handleImagePreview(this, '#answerImagePreview');
                    });

                    // --- Dropdowns dependientes ---
                    function loadTopics(subjectId, selectedTopicId = null) {
                        if (!subjectId) {
                            $('#id_topic').html('<option value="">Seleccione una materia primero</option>').prop('disabled', true);
                            $('#id_subtopic').html('<option value="">Seleccione un tema primero</option>').prop('disabled', true);
                            return;
                        }
                        $.ajax({
                            url: '{% url "material:get_topics" %}',
                            data: { 'subject_id': subjectId },
                            success: function(data) {
                                let options = '<option value="">Seleccione un tema</option>';
                                data.forEach(function(topic) {
                                    const selected = topic.id == selectedTopicId ? 'selected' : '';
                                    options += `<option value="${topic.id}" ${selected}>${topic.name}</option>`;
                                });
                                $('#id_topic').html(options).prop('disabled', false);
                                $('#id_subtopic').html('<option value="">Seleccione un tema primero</option>').prop('disabled', true);
                            }
                        });
                    }
                    function loadSubtopics(topicId, selectedSubtopicId = null) {
                        if (!topicId) {
                            $('#id_subtopic').html('<option value="">Seleccione un tema primero</option>').prop('disabled', true);
                            return;
                        }
                        $.ajax({
                            url: '{% url "material:get_subtopics" %}',
                            data: { 'topic_id': topicId },
                            success: function(data) {
                                let options = '<option value="">Sin subtema</option>';
                                data.forEach(function(subtopic) {
                                    const selected = subtopic.id == selectedSubtopicId ? 'selected' : '';
                                    options += `<option value="${subtopic.id}" ${selected}>${subtopic.name}</option>`;
                                });
                                $('#id_subtopic').html(options).prop('disabled', false);
                            }
                        });
                    }
                    $('#{{ form.subject.id_for_label }}').change(function() {
                        loadTopics($(this).val());
                    });
                    $('#id_topic').change(function() {
                        loadSubtopics($(this).val());
                    });
                    // Inicialización
                    const subjectId = $('#{{ form.subject.id_for_label }}').val();
                    if (subjectId) {
                        loadTopics(subjectId);
                    }

                    // --- Crear nuevo tema ---
                    $('#addTopicBtn').click(function() {
                        $('#newTopicContainer').show();
                        $('#new_topic').val('').focus();
                    });
                    $('#cancelNewTopic').click(function() {
                        $('#newTopicContainer').hide();
                        $('#new_topic').val('');
                    });
                    $('#saveNewTopic').click(function() {
                        const name = $('#new_topic').val().trim();
                        const subjectId = $('#{{ form.subject.id_for_label }}').val();
                        if (!name || !subjectId) return;
                        $.ajax({
                            url: '{% url "material:add_topic" %}',
                            method: 'POST',
                            data: {
                                'name': name,
                                'subject_id': subjectId,
                                'csrfmiddlewaretoken': '{{ csrf_token }}'
                            },
                            success: function(response) {
                                if (response.success) {
                                    loadTopics(subjectId, response.topic.id);
                                    $('#newTopicContainer').hide();
                                } else {
                                    alert(response.error || 'Error al crear el tema');
                                }
                            }
                        });
                    });

                    // --- Crear nuevo subtema ---
                    $('#addSubtopicBtn').click(function() {
                        $('#newSubtopicContainer').show();
                        $('#new_subtopic').val('').focus();
                    });
                    $('#cancelNewSubtopic').click(function() {
                        $('#newSubtopicContainer').hide();
                        $('#new_subtopic').val('');
                    });
                    $('#saveNewSubtopic').click(function() {
                        const name = $('#new_subtopic').val().trim();
                        const topicId = $('#id_topic').val();
                        if (!name || !topicId) return;
                        $.ajax({
                            url: '{% url "material:add_subtopic" %}',
                            method: 'POST',
                            data: JSON.stringify({
                                'name': name,
                                'topic_id': topicId
                            }),
                            contentType: 'application/json',
                            headers: {
                                'X-CSRFToken': '{{ csrf_token }}'
                            },
                            success: function(response) {
                                if (response.success) {
                                    loadSubtopics(topicId, response.subtopic.id);
                                    $('#newSubtopicContainer').hide();
                                } else {
                                    alert(response.error || 'Error al crear el subtema');
                                }
                            }
                        });
                    });
                });
                </script>
            newTopicInput.focus();
        });
        newTopicInput.style.display = 'none';
    }

    // Mostrar input de nuevo subtema
    const showNewSubtopicBtn = document.getElementById('showNewSubtopicInput');
    const newSubtopicInput = document.getElementById('newSubtopicInput');
    if (showNewSubtopicBtn && newSubtopicInput) {
        showNewSubtopicBtn.addEventListener('click', function() {
            newSubtopicInput.style.display = '';
            newSubtopicInput.focus();
        });
        newSubtopicInput.style.display = 'none';
    }
});
</script>

<style>
    .nav-tabs .nav-link {
        color: {% if dark_mode %}#ffffff{% else %}#495057{% endif %};
        background-color: {% if dark_mode %}#343a40{% else %}#f8f9fa{% endif %};
    }
    .nav-tabs .nav-link.active {
        color: {% if dark_mode %}#000000{% else %}#495057{% endif %};
        background-color: {% if dark_mode %}#f8f9fa{% else %}#ffffff{% endif %};
    }
    
    .input-group-append .btn {
        border-radius: 0 .25rem .25rem 0;
    }
    
    #questionImagePreview img, 
    #answerImagePreview img {
        max-height: 200px;
        object-fit: contain;
    }
</style>
{% endblock %}
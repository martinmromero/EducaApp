<div class="modal-body">
    <form id="edit-institution-form" method="post" action="{% url 'material:edit_institution' institution.pk %}" enctype="multipart/form-data">
        {% csrf_token %}
        
        <input type="hidden" name="institution_id" value="{{ institution.pk }}">
        
        <div class="mb-3">
            <label class="form-label">Nombre*</label>
            <input type="text" name="name" class="form-control" value="{{ institution.name }}" required>
            <div class="invalid-feedback">Por favor ingrese un nombre válido</div>
        </div>

        <div class="mb-3">
            <label class="form-label">Sedes (Opcional)</label>
            <div id="edit-campuses-container">
                {% for campus in institution.campuses.all %}
                <div class="input-group mb-2 campuses-item">
                    <input type="text" name="campuses" class="form-control" value="{{ campus.name }}">
                    <button type="button" class="btn btn-outline-danger remove-btn">
                        <i class="bi bi-trash"></i>
                    </button>
                </div>
                {% endfor %}
            </div>
            <button type="button" id="edit-add-campus" class="btn btn-sm btn-outline-primary mt-2">
                <i class="bi bi-plus-circle"></i> Agregar Sede
            </button>
        </div>

        <div class="mb-3">
            <label class="form-label">Facultades (Opcional)</label>
            <div id="edit-faculties-container">
                {% for faculty in institution.faculties.all %}
                <div class="input-group mb-2 faculties-item">
                    <input type="text" name="faculties" class="form-control" value="{{ faculty.name }}">
                    <button type="button" class="btn btn-outline-danger remove-btn">
                        <i class="bi bi-trash"></i>
                    </button>
                </div>
                {% endfor %}
            </div>
            <button type="button" id="edit-add-faculty" class="btn btn-sm btn-outline-primary mt-2">
                <i class="bi bi-plus-circle"></i> Agregar Facultad
            </button>
        </div>

        <div class="mb-3">
            <label class="form-label">Logo (Opcional)</label>
            <input type="file" name="logo" class="form-control" accept=".jpg,.jpeg,.png,.svg">
            {% if institution.logo %}
            <div class="mt-2">
                <img src="{{ institution.logo.url }}" alt="Logo actual" class="img-thumbnail" width="100">
                <div class="form-check mt-2">
                    <input class="form-check-input" type="checkbox" name="logo-clear" id="logo-clear">
                    <label class="form-check-label" for="logo-clear">Eliminar logo actual</label>
                </div>
            </div>
            {% endif %}
        </div>

        <div class="modal-footer">
            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
            <button type="button" id="edit-save-btn" class="btn btn-primary">
                <span id="edit-submit-text">Guardar cambios</span>
                <span id="edit-submit-spinner" class="spinner-border spinner-border-sm d-none"></span>
            </button>
        </div>
    </form>
</div>

<script>
// Script específico para el modal de edición
function initEditHandlers() {
    // Template para campos dinámicos en edición
    const editFieldTemplate = (type) => `
    <div class="input-group mb-2 ${type}-item">
        <input type="text" name="${type}" class="form-control">
        <button type="button" class="btn btn-outline-danger remove-btn">
            <i class="bi bi-trash"></i>
        </button>
    </div>`;

    // Agregar campos en edición
    document.getElementById('edit-add-campus')?.addEventListener('click', () => {
        document.getElementById('edit-campuses-container').insertAdjacentHTML('beforeend', editFieldTemplate('campuses'));
    });

    document.getElementById('edit-add-faculty')?.addEventListener('click', () => {
        document.getElementById('edit-faculties-container').insertAdjacentHTML('beforeend', editFieldTemplate('faculties'));
    });

    // Validación para edición
    function validateEditForm(formData) {
        if (!formData.get('name')?.trim()) {
            throw new Error('El nombre es requerido');
        }
        
        const logoFile = formData.get('logo');
        if (logoFile && logoFile.size > 0) {
            if (logoFile.size > 2 * 1024 * 1024) {
                throw new Error('El logo no debe exceder 2MB');
            }
            const validTypes = ['image/jpeg', 'image/png', 'image/svg+xml'];
            if (!validTypes.includes(logoFile.type)) {
                throw new Error('Formato de imagen no válido');
            }
        }
        return true;
    }

    // Guardar cambios en edición
    document.getElementById('edit-save-btn')?.addEventListener('click', async function() {
        const form = document.getElementById('edit-institution-form');
        const submitBtn = this;
        const submitText = document.getElementById('edit-submit-text');
        const spinner = document.getElementById('edit-submit-spinner');
        
        submitBtn.disabled = true;
        submitText.textContent = 'Guardando...';
        spinner.classList.remove('d-none');

        try {
            const formData = new FormData(form);
            
            // Validación
            validateEditForm(formData);
            
            // Agregar campos dinámicos
            document.querySelectorAll('#edit-campuses-container input').forEach(input => {
                if (input.value.trim()) formData.append('campuses', input.value.trim());
            });
            
            document.querySelectorAll('#edit-faculties-container input').forEach(input => {
                if (input.value.trim()) formData.append('faculties', input.value.trim());
            });

            const response = await fetch(form.action, {
                method: 'POST',
                body: formData,
                headers: {
                    'X-Requested-With': 'XMLHttpRequest',
                    'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
                }
            });

            const data = await response.json();
            
            if (data.success) {
                document.getElementById('institutions-table-body').innerHTML = data.html;
                bootstrap.Modal.getInstance(document.getElementById('editInstitutionModal')).hide();
                showAlert('success', 'Institución actualizada correctamente');
            } else {
                throw new Error(data.errors || 'Error al guardar cambios');
            }
        } catch (error) {
            console.error('Error:', error);
            showAlert('danger', 'Error: ' + error.message);
        } finally {
            submitBtn.disabled = false;
            submitText.textContent = 'Guardar cambios';
            spinner.classList.add('d-none');
        }
    });
}
</script>
{% extends 'material/base.html' %}
{% load static %}

{% block content %}
<div class="container-fluid">
    {% csrf_token %}
    <h1 class="h3 mb-4 text-gray-800">{{ oral_exam.name }}</h1>
    
    <!-- Información del examen -->
    <div class="card shadow mb-4">
        <div class="card-header py-3">
            <h6 class="m-0 font-weight-bold text-primary">Información del Examen Oral</h6>
        </div>
        <div class="card-body">
            <div class="row">
                <div class="col-md-6">
                    <p><strong>Materia:</strong> {{ oral_exam.subject.name }}</p>
                    <p><strong>Número de grupos:</strong> {{ oral_exam.num_groups }}</p>
                    <p><strong>Estudiantes por grupo:</strong> {{ oral_exam.students_per_group }}</p>
                </div>
                <div class="col-md-6">
                    <p><strong>Preguntas por estudiante:</strong> {{ oral_exam.questions_per_student }}</p>
                    <p><strong>Creado:</strong> {{ oral_exam.created_at|date:"d/m/Y H:i" }}</p>
                    <p><strong>Total de estudiantes:</strong> {{ total_students }}</p>
                </div>
            </div>
            <div class="mt-3">
                <p><strong>Temas evaluados:</strong></p>
                <ul>
                    {% for topic in oral_exam.topics.all %}
                        <li>{{ topic.name }}</li>
                    {% endfor %}
                </ul>
            </div>
        </div>
    </div>
    
    <!-- Panel de control -->
    <div class="card shadow mb-4">
        <div class="card-header py-3">
            <h6 class="m-0 font-weight-bold text-primary">Panel de Control del Examen</h6>
        </div>
        <div class="card-body">
            <div class="row">
                <div class="col-md-6">
                    <label class="form-label"><strong>Modo de Visualización:</strong></label>
                    <div class="form-check">
                        <input class="form-check-input" type="radio" name="viewMode" id="roundRobinMode" value="roundRobin" checked>
                        <label class="form-check-label" for="roundRobinMode">
                            <i class="fas fa-sync-alt"></i> Round Robin (1 pregunta por vuelta)
                        </label>
                    </div>
                    <div class="form-check">
                        <input class="form-check-input" type="radio" name="viewMode" id="listMode" value="list">
                        <label class="form-check-label" for="listMode">
                            <i class="fas fa-list"></i> Listar todas las preguntas por estudiante
                        </label>
                    </div>
                </div>
                <div class="col-md-6">
                    <!-- Los controles están al final de la página -->
                </div>
            </div>
            
            <!-- Asignación de nombres de estudiantes -->
            <div class="row mt-3">
                <div class="col-12">
                    <div class="alert alert-warning">
                        <h6><i class="fas fa-users"></i> Asignación de Nombres de Estudiantes</h6>
                        <div class="row">
                            <div class="col-md-8">
                                <label for="studentNames" class="form-label">
                                    Lista de nombres (uno por línea, se asignarán aleatoriamente):
                                </label>
                                <textarea class="form-control" id="studentNames" rows="4" 
                                          placeholder="Juan Pérez&#10;María García&#10;Carlos López&#10;Ana Rodríguez"></textarea>
                                <small class="form-text text-muted">
                                    Se necesitan al menos {{ total_students }} nombres para todos los estudiantes.
                                </small>
                            </div>
                            <div class="col-md-4 d-flex align-items-end">
                                <button type="button" class="btn btn-primary btn-block" id="assignNamesBtn">
                                    <i class="fas fa-random"></i> Asignar Nombres Aleatoriamente
                                </button>
                            </div>
                        </div>
                        <div id="nameAssignmentResult" class="mt-2"></div>
                    </div>
                </div>
            </div>

            <!-- Resumen de evaluaciones -->
            <div class="row mt-3">
                <div class="col-12">
                    <div class="alert alert-info">
                        <h6><i class="fas fa-chart-bar"></i> Resumen de Evaluaciones</h6>
                        <div class="row text-center">
                            <div class="col-3">
                                <span class="badge badge-success badge-pill" style="font-size: 1rem;">
                                    <i class="fas fa-check"></i> Bien: <span id="goodCount">0</span>
                                </span>
                            </div>
                            <div class="col-3">
                                <span class="badge badge-warning badge-pill" style="font-size: 1rem;">
                                    <i class="fas fa-minus"></i> Regular: <span id="regularCount">0</span>
                                </span>
                            </div>
                            <div class="col-3">
                                <span class="badge badge-danger badge-pill" style="font-size: 1rem;">
                                    <i class="fas fa-times"></i> Mal: <span id="badCount">0</span>
                                </span>
                            </div>
                            <div class="col-3">
                                <span class="badge badge-secondary badge-pill" style="font-size: 1rem;">
                                    <i class="fas fa-clock"></i> Pendientes: <span id="pendingCount">{{ total_questions }}</span>
                                </span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Grupos y preguntas -->
    {% for group in groups %}
    <div class="card shadow mb-4" id="group-{{ group.group_number }}" data-group-number="{{ group.group_number }}">
        <div class="card-header py-3 d-flex justify-content-between align-items-center">
            <h6 class="m-0 font-weight-bold text-primary">Grupo {{ group.group_number }}</h6>
            <button class="btn btn-sm btn-info" onclick="printGroup({{ group.group_number }})">
                <i class="fas fa-print"></i> Imprimir Grupo
            </button>
        </div>
        <div class="card-body">
            <div class="row">
                {% for student in group.students.all %}
                <div class="col-md-6 mb-4">
                    <div class="border rounded p-3 h-100" data-student-id="{{ student.id }}">
                        <div class="d-flex justify-content-between align-items-start mb-2">
                            <div>
                                <h5 class="text-primary mb-1">
                                    {% if student.student_name %}
                                        {{ student.student_name }}
                                    {% else %}
                                        Estudiante {{ student.student_number }}
                                    {% endif %}
                                </h5>
                                {% if student.student_name %}
                                    <small class="text-muted">Número: {{ student.student_number }}</small>
                                {% endif %}
                            </div>
                            <div class="text-right">
                                <small class="d-block text-muted">Progreso: <span class="progress-percent">0%</span></small>
                                <small class="d-block text-success">Correctas: <span class="score-percent">0%</span></small>
                            </div>
                        </div>
                        
                        <!-- Barra de progreso del estudiante -->
                        <div class="progress mb-3" style="height: 6px;">
                            <div class="progress-bar bg-info progress-bar-student" role="progressbar" 
                                 style="width: 0%" aria-valuenow="0" aria-valuemin="0" aria-valuemax="100">
                            </div>
                        </div>
                        <div class="questions-list">
                            {% for sq in student.oralexamstudentquestion_set.all %}
                            <div class="question-item mb-3" data-question-order="{{ sq.order }}">
                                <div class="d-flex justify-content-between align-items-start mb-2">
                                    <div class="d-flex align-items-center">
                                        <strong class="text-dark">Pregunta {{ sq.order }}:</strong>
                                        <button class="btn btn-sm btn-outline-warning ml-2 change-question-btn" 
                                                data-student-question-id="{{ sq.id }}" 
                                                data-group-id="{{ student.group.id }}"
                                                data-current-question-id="{{ sq.question.id }}"
                                                title="Cambiar esta pregunta por otra">
                                            <i class="fas fa-exchange-alt"></i> Cambiar
                                        </button>
                                    </div>
                                    <div class="text-right">
                                        {% if sq.question.subtopic %}
                                            <small class="text-muted">{{ sq.question.subtopic.name }}</small>
                                        {% else %}
                                            <small class="text-muted">{{ sq.question.topic.name }}</small>
                                        {% endif %}
                                    </div>
                                </div>
                                <p class="mt-2 mb-1">{{ sq.question.question_text }}</p>
                                {% if sq.question.question_image %}
                                    <img src="{{ sq.question.question_image.url }}" class="img-fluid mt-2" style="max-width: 200px;">
                                {% endif %}
                                <details class="mt-2">
                                    <summary class="text-success cursor-pointer">Ver respuesta</summary>
                                    <div class="mt-2 p-2 bg-light rounded">
                                        <p>{{ sq.question.answer_text }}</p>
                                        {% if sq.question.answer_image %}
                                            <img src="{{ sq.question.answer_image.url }}" class="img-fluid mt-2" style="max-width: 200px;">
                                        {% endif %}
                                        {% if sq.question.source_page %}
                                            <small class="text-muted d-block mt-2">Página de referencia: {{ sq.question.source_page }}</small>
                                        {% endif %}
                                    </div>
                                </details>
                                
                                <!-- Sistema de evaluación -->
                                <div class="evaluation-section mt-3" data-student-question-id="{{ sq.id }}">
                                    <div class="d-flex justify-content-between align-items-center">
                                        <small class="text-muted">
                                            <strong>Evaluación:</strong> 
                                            <span class="current-evaluation text-{{ sq.evaluation|default:'secondary' }}">
                                                {% if sq.evaluation == 'bien' %}✓ Bien
                                                {% elif sq.evaluation == 'regular' %}~ Regular  
                                                {% elif sq.evaluation == 'mal' %}✗ Mal
                                                {% else %}⏳ Pendiente{% endif %}
                                            </span>
                                        </small>
                                        <div class="btn-group btn-group-sm" role="group">
                                            <button type="button" class="btn {% if sq.evaluation == 'bien' %}btn-success{% else %}btn-outline-success{% endif %} eval-btn" 
                                                    data-evaluation="bien" data-student-question-id="{{ sq.id }}">
                                                <i class="fas fa-check"></i> Bien
                                            </button>
                                            <button type="button" class="btn {% if sq.evaluation == 'regular' %}btn-warning{% else %}btn-outline-warning{% endif %} eval-btn" 
                                                    data-evaluation="regular" data-student-question-id="{{ sq.id }}">
                                                <i class="fas fa-minus"></i> Regular
                                            </button>
                                            <button type="button" class="btn {% if sq.evaluation == 'mal' %}btn-danger{% else %}btn-outline-danger{% endif %} eval-btn" 
                                                    data-evaluation="mal" data-student-question-id="{{ sq.id }}">
                                                <i class="fas fa-times"></i> Mal
                                            </button>
                                            <button type="button" class="btn {% if sq.evaluation == 'pendiente' %}btn-secondary{% else %}btn-outline-secondary{% endif %} eval-btn" 
                                                    data-evaluation="pendiente" data-student-question-id="{{ sq.id }}">
                                                <i class="fas fa-clock"></i> Pendiente
                                            </button>
                                        </div>
                                    </div>
                                    {% if sq.notes %}
                                        <div class="mt-2">
                                            <small class="text-muted"><strong>Notas:</strong> {{ sq.notes }}</small>
                                        </div>
                                    {% endif %}
                                </div>
                            </div>
                            {% endfor %}
                        </div>
                    </div>
                </div>
                {% endfor %}
            </div>
        </div>
    </div>
    {% endfor %}
    
    <!-- Controles Round Robin -->
    <div id="roundRobinControls" class="mt-4" style="display: none;">
        <div class="card">
            <div class="card-body">
                <div class="d-flex justify-content-between align-items-center">
                    <button type="button" class="btn btn-outline-primary" id="prevQuestion">
                        <i class="fas fa-chevron-left"></i> Anterior
                    </button>
                    
                    <div class="text-center">
                        <h5 class="mb-0"><span id="currentQuestionNumber">Grupo 1 - Pregunta 1</span></h5>
                        <small class="text-muted">de {{ oral_exam.num_groups }} grupos × {{ oral_exam.questions_per_student }} preguntas</small>
                    </div>
                    
                    <button type="button" class="btn btn-outline-primary" id="nextQuestion">
                        Siguiente <i class="fas fa-chevron-right"></i>
                    </button>
                </div>
            </div>
        </div>
    </div>
    
    <div class="mt-4">
        <button class="btn btn-success" onclick="printAll()">
            <i class="fas fa-print"></i> Imprimir Todo
        </button>
        <a href="{% url 'material:list_oral_exams' %}" class="btn btn-secondary">
            <i class="fas fa-arrow-left"></i> Volver a la lista
        </a>
        <a href="{% url 'material:create_oral_exam' %}" class="btn btn-primary">
            <i class="fas fa-plus"></i> Crear Otro Cuestionario
        </a>
    </div>
</div>

<!-- Modal para cambiar pregunta -->
<div class="modal fade" id="changeQuestionModal" tabindex="-1" role="dialog" aria-labelledby="changeQuestionModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg" role="document">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="changeQuestionModalLabel">
                    <i class="fas fa-exchange-alt"></i> Cambiar Pregunta
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <div class="mb-3">
                    <h6>Pregunta actual:</h6>
                    <div id="currentQuestionText" class="p-2 bg-light rounded"></div>
                </div>
                
                <div class="mb-3">
                    <h6>Seleccionar nueva pregunta:</h6>
                    <div id="availableQuestionsContainer">
                        <div class="text-center">
                            <div class="spinner-border" role="status">
                                <span class="visually-hidden">Cargando...</span>
                            </div>
                            <p class="mt-2">Cargando preguntas disponibles...</p>
                        </div>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                <button type="button" class="btn btn-primary" id="confirmExchangeBtn" disabled>
                    <i class="fas fa-check"></i> Confirmar Cambio
                </button>
            </div>
        </div>
    </div>
</div>

<style>
@media print {
    .no-print {
        display: none !important;
    }
    
    .card {
        border: 1px solid #333 !important;
        page-break-inside: avoid;
    }
    
    .question-item {
        page-break-inside: avoid;
    }
}

.cursor-pointer {
    cursor: pointer;
}

details > summary {
    list-style: none;
}

details > summary::-webkit-details-marker {
    display: none;
}

details > summary::before {
    content: '▶ ';
}

details[open] > summary::before {
    content: '▼ ';
}

.question-item {
    display: block;
}

.question-item.hidden {
    display: none !important;
}

/* Mejora visual para round robin */
.round-robin-mode .question-item + .question-item {
    border-top: none;
}

/* Estilos para botón cambiar pregunta */
.change-question-btn {
    font-size: 0.75rem;
    padding: 0.25rem 0.5rem;
}

.change-question-btn:hover {
    background-color: #ffc107;
    border-color: #ffc107;
    color: #212529;
}

/* Estilos para modal de intercambio */
.list-group-item:hover {
    background-color: #f8f9fa;
}

.list-group-item input[type="radio"]:checked + div {
    font-weight: bold;
}

.eval-btn.active {
    color: white !important;
}

.eval-btn[data-score="good"].active {
    background-color: #28a745;
    border-color: #28a745;
}

.eval-btn[data-score="regular"].active {
    background-color: #ffc107;
    border-color: #ffc107;
}

.eval-btn[data-score="bad"].active {
    background-color: #dc3545;
    border-color: #dc3545;
}

.hidden {
    display: none !important;
}
</style>

<script>
// URLs de Django para AJAX
const URLS = {
    evaluateQuestion: '{% url "material:evaluate_oral_question" %}',
    assignNames: '{% url "material:assign_student_names" %}',
    getAvailableQuestions: '{% url "material:get_available_questions" %}',
    exchangeQuestion: '{% url "material:exchange_question" %}'
};

// Variables globales para Round Robin
let currentGroup = 1;
let currentRound = 1;
let maxGroups = {{ oral_exam.num_groups }};
let maxRounds = parseInt('{{ oral_exam.questions_per_student }}');
let viewMode = 'roundRobin';  // Round Robin como default

// Sistema de evaluación
const evaluations = {};

document.addEventListener('DOMContentLoaded', function() {
    console.log('DOM loaded, initializing complete oral exam interface...');
    
    // Restaurar el modo de visualización guardado (si existe)
    const savedViewMode = localStorage.getItem('oralExamViewMode');
    if (savedViewMode) {
        viewMode = savedViewMode;
        // Marcar el radio button correcto
        if (savedViewMode === 'roundRobin') {
            document.getElementById('roundRobinMode').checked = true;
            document.getElementById('roundRobinControls').style.display = 'block';
        } else {
            document.getElementById('listMode').checked = true;
            document.getElementById('roundRobinControls').style.display = 'none';
        }
    } else {
        // Si no hay modo guardado, usar Round Robin por defecto
        document.getElementById('roundRobinControls').style.display = 'block';
    }
    
    // Configurar controles de vista y evaluación
    setupViewModeControls();
    setupEvaluationSystem();
    updateView();
    
    // Manejar asignación de nombres
    const assignBtn = document.getElementById('assignNamesBtn');
    if (assignBtn) {
        assignBtn.addEventListener('click', function() {
            console.log('Assign names button clicked');
            const studentNames = document.getElementById('studentNames').value;
            if (!studentNames.trim()) {
                alert('Por favor, ingrese los nombres de los estudiantes.');
                return;
            }
            
            assignStudentNames(studentNames);
        });
    } else {
        console.log('assignNamesBtn element not found');
    }
    
    // Confirmar intercambio
    const confirmBtn = document.getElementById('confirmExchangeBtn');
    if (confirmBtn) {
        confirmBtn.addEventListener('click', function() {
            if (selectedNewQuestionId && currentStudentQuestionId) {
                exchangeQuestion(currentStudentQuestionId, selectedNewQuestionId);
            }
        });
    }
    
    // Event listener principal para clicks
    document.addEventListener('click', function(e) {
        // Manejar clicks en botones de evaluación
        if (e.target.classList.contains('eval-btn') || e.target.parentElement.classList.contains('eval-btn')) {
            const btn = e.target.classList.contains('eval-btn') ? e.target : e.target.parentElement;
            const studentQuestionId = btn.getAttribute('data-student-question-id');
            const evaluation = btn.getAttribute('data-evaluation');
            
            console.log('Evaluating question:', studentQuestionId, 'with evaluation:', evaluation);
            evaluateQuestion(studentQuestionId, evaluation, btn);
        }
        
        // Manejar clicks en botones "Cambiar pregunta"
        if (e.target.classList.contains('change-question-btn') || e.target.closest('.change-question-btn')) {
            const btn = e.target.classList.contains('change-question-btn') ? e.target : e.target.closest('.change-question-btn');
            console.log('Change question button clicked:', btn);
            openChangeQuestionModal(btn);
        }
    });

    // Event listener para selección de nueva pregunta
    document.addEventListener('change', function(e) {
        if (e.target.name === 'newQuestionRadio') {
            selectedNewQuestionId = e.target.value;
            const confirmBtn = document.getElementById('confirmExchangeBtn');
            if (confirmBtn) {
                confirmBtn.disabled = false;
            }
        }
    });

    // Inicializar contadores
    updateEvaluationCounters();
    console.log('Complete oral exam interface initialized successfully');
});

function setupViewModeControls() {
    const listMode = document.getElementById('listMode');
    const roundRobinMode = document.getElementById('roundRobinMode');
    const roundRobinControls = document.getElementById('roundRobinControls');
    const prevBtn = document.getElementById('prevQuestion');
    const nextBtn = document.getElementById('nextQuestion');
    
    console.log('Elements found:', {listMode, roundRobinMode, roundRobinControls, prevBtn, nextBtn});
    
    listMode.addEventListener('change', function() {
        if (this.checked) {
            viewMode = 'list';
            localStorage.setItem('oralExamViewMode', 'list');  // Guardar preferencia
            roundRobinControls.style.display = 'none';
            updateView();
        }
    });
    
    roundRobinMode.addEventListener('change', function() {
        if (this.checked) {
            viewMode = 'roundRobin';
            localStorage.setItem('oralExamViewMode', 'roundRobin');  // Guardar preferencia
            roundRobinControls.style.display = 'block';
            updateView();
        }
    });
    
    prevBtn.addEventListener('click', function() {
        navigatePrevious();
    });
    
    nextBtn.addEventListener('click', function() {
        navigateNext();
    });
}

function navigatePrevious() {
    if (currentRound > 1) {
        // Ir a la pregunta anterior en el mismo grupo
        currentRound--;
    } else if (currentGroup > 1) {
        // Ir al grupo anterior, última pregunta
        currentGroup--;
        currentRound = maxRounds;
    }
    updateView();
}

function navigateNext() {
    if (currentRound < maxRounds) {
        // Ir a la siguiente pregunta en el mismo grupo
        currentRound++;
    } else if (currentGroup < maxGroups) {
        // Ir al siguiente grupo, primera pregunta
        currentGroup++;
        currentRound = 1;
    }
    updateView();
}

function setupEvaluationSystem() {
    document.addEventListener('click', function(e) {
        if (e.target.classList.contains('eval-btn') || e.target.parentElement.classList.contains('eval-btn')) {
            const btn = e.target.classList.contains('eval-btn') ? e.target : e.target.parentElement;
            const questionId = btn.closest('[data-question-id]').getAttribute('data-question-id');
            const score = btn.getAttribute('data-score');
            
            // Limpiar selecciones anteriores del mismo grupo
            const btnGroup = btn.closest('.btn-group');
            btnGroup.querySelectorAll('.eval-btn').forEach(b => b.classList.remove('active'));
            
            if (score === 'clear') {
                delete evaluations[questionId];
            } else {
                // Activar botón seleccionado
                btn.classList.add('active');
                evaluations[questionId] = score;
            }
            
            updateEvaluationSummary();
        }
    });
}

function updateView() {
    console.log('updateView called:', {viewMode, currentGroup, currentRound});
    const allGroups = document.querySelectorAll('.card[id^="group-"]');
    const body = document.body;
    console.log('Found groups:', allGroups.length);
    
    if (viewMode === 'list') {
        // Remover clase round robin
        body.classList.remove('round-robin-mode');
        
        // Mostrar todos los grupos y todas las preguntas
        allGroups.forEach(group => {
            group.style.display = 'block';
            const questionItems = group.querySelectorAll('.question-item');
            questionItems.forEach(item => {
                item.classList.remove('hidden');
            });
        });
    } else if (viewMode === 'roundRobin') {
        // Agregar clase round robin
        body.classList.add('round-robin-mode');
        // Mostrar solo el grupo actual y la ronda actual
        allGroups.forEach(group => {
            const groupNumber = parseInt(group.getAttribute('data-group-number'));
            
            if (groupNumber === currentGroup) {
                group.style.display = 'block';
                
                // Dentro del grupo actual, mostrar solo la pregunta de la ronda actual
                const questionItems = group.querySelectorAll('.question-item');
                questionItems.forEach(item => {
                    const questionOrder = parseInt(item.dataset.questionOrder);
                    if (questionOrder === currentRound) {
                        item.classList.remove('hidden');
                    } else {
                        item.classList.add('hidden');
                    }
                });
            } else {
                group.style.display = 'none';
            }
        });
        
        // Actualizar contador
        document.getElementById('currentQuestionNumber').textContent = 
            `Grupo ${currentGroup} - Pregunta ${currentRound}`;
        
        // Habilitar/deshabilitar botones de navegación
        const isFirstPage = (currentGroup === 1 && currentRound === 1);
        const isLastPage = (currentGroup === maxGroups && currentRound === maxRounds);
        
        document.getElementById('prevQuestion').disabled = isFirstPage;
        document.getElementById('nextQuestion').disabled = isLastPage;
    }
}

function updateEvaluationSummary() {
    // Contar evaluaciones
    const counts = { good: 0, regular: 0, bad: 0 };
    Object.values(evaluations).forEach(score => {
        counts[score]++;
    });
    
    // Actualizar el título de la página con el progreso
    const total = Object.keys(evaluations).length;
    const totalQuestions = document.querySelectorAll('.question-item').length;
    document.title = `Cuestionario Oral - ${total}/${totalQuestions} evaluadas`;
}

function printGroup(groupNumber) {
    // Ocultar elementos que no queremos imprimir
    const elements = document.querySelectorAll('.card-header button, .mt-4, .no-print');
    elements.forEach(el => el.style.display = 'none');
    
    // Ocultar otros grupos
    const allGroups = document.querySelectorAll('[id^="group-"]');
    allGroups.forEach(group => {
        if (group.id !== `group-${groupNumber}`) {
            group.closest('.card').style.display = 'none';
        }
    });
    
    window.print();
    
    // Restaurar elementos después de imprimir
    setTimeout(() => {
        elements.forEach(el => el.style.display = '');
        allGroups.forEach(group => {
            group.closest('.card').style.display = '';
        });
    }, 1000);
}

function printAll() {
    // Ocultar botones durante la impresión
    const buttons = document.querySelectorAll('.card-header button, .mt-4');
    buttons.forEach(btn => btn.style.display = 'none');
    
    window.print();
    
    // Restaurar botones después de imprimir
    setTimeout(() => {
        buttons.forEach(btn => btn.style.display = '');
    }, 1000);
}

// Event listeners ahora están dentro del DOMContentLoaded

// Funciones para evaluaciones y nombres (ya incluidas en DOMContentLoaded principal)

function evaluateQuestion(studentQuestionId, evaluation, btn) {
    const formData = new FormData();
    formData.append('student_question_id', studentQuestionId);
    formData.append('evaluation', evaluation);
    formData.append('csrfmiddlewaretoken', document.querySelector('[name=csrfmiddlewaretoken]').value);
    
    fetch(URLS.evaluateQuestion, {
        method: 'POST',
        body: formData
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            // Actualizar botones de evaluación
            const evaluationSection = btn.closest('.evaluation-section');
            const buttons = evaluationSection.querySelectorAll('.eval-btn');
            
            buttons.forEach(b => {
                b.classList.remove('btn-success', 'btn-warning', 'btn-danger', 'btn-secondary');
                b.classList.add('btn-outline-' + getButtonColor(b.getAttribute('data-evaluation')));
            });
            
            // Activar botón seleccionado
            btn.classList.remove('btn-outline-' + getButtonColor(evaluation));
            btn.classList.add('btn-' + getButtonColor(evaluation));
            
            // Actualizar texto de evaluación actual
            const currentEval = evaluationSection.querySelector('.current-evaluation');
            currentEval.textContent = getEvaluationText(evaluation);
            currentEval.className = 'current-evaluation text-' + getButtonColor(evaluation);
            
            // Actualizar contadores del estudiante
            const studentDiv = evaluationSection.closest('[data-student-id]');
            const studentId = studentDiv.getAttribute('data-student-id');
            updateStudentProgress(studentId, data.evaluation_counts, data.progress_percentage, data.score_percentage);
            
            // Actualizar contadores globales
            updateEvaluationCounters();
        } else {
            alert('Error al evaluar: ' + data.error);
        }
    })
    .catch(error => {
        console.error('Error:', error);
        alert('Error de conexión al evaluar la pregunta.');
    });
}

function assignStudentNames(studentNames) {
    const formData = new FormData();
    formData.append('exam_id', '{{ oral_exam.id }}');
    formData.append('student_names', studentNames);
    formData.append('csrfmiddlewaretoken', document.querySelector('[name=csrfmiddlewaretoken]').value);
    
    fetch(URLS.assignNames, {
        method: 'POST',
        body: formData
    })
    .then(response => response.json())
    .then(data => {
        const resultDiv = document.getElementById('nameAssignmentResult');
        if (data.success) {
            resultDiv.innerHTML = `
                <div class="alert alert-success alert-dismissible fade show">
                    <i class="fas fa-check"></i> ${data.message}
                    <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
                </div>
            `;
            // Recargar la página para mostrar los nombres asignados
            setTimeout(() => location.reload(), 1500);
        } else {
            resultDiv.innerHTML = `
                <div class="alert alert-danger alert-dismissible fade show">
                    <i class="fas fa-exclamation-triangle"></i> ${data.error}
                    <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
                </div>
            `;
        }
    })
    .catch(error => {
        console.error('Error:', error);
        alert('Error de conexión al asignar nombres.');
    });
}

function getButtonColor(evaluation) {
    const colors = {
        'bien': 'success',
        'regular': 'warning', 
        'mal': 'danger',
        'pendiente': 'secondary'
    };
    return colors[evaluation] || 'secondary';
}

function getEvaluationText(evaluation) {
    const texts = {
        'bien': '✓ Bien',
        'regular': '~ Regular',
        'mal': '✗ Mal', 
        'pendiente': '⏳ Pendiente'
    };
    return texts[evaluation] || '⏳ Pendiente';
}

function updateStudentProgress(studentId, counts, progressPercent, scorePercent) {
    const studentDiv = document.querySelector(`[data-student-id="${studentId}"]`);
    if (studentDiv) {
        const progressSpan = studentDiv.querySelector('.progress-percent');
        const scoreSpan = studentDiv.querySelector('.score-percent');
        const progressBar = studentDiv.querySelector('.progress-bar-student');
        
        if (progressSpan) progressSpan.textContent = progressPercent + '%';
        if (scoreSpan) scoreSpan.textContent = scorePercent + '%';
        if (progressBar) progressBar.style.width = progressPercent + '%';
    }
}

function updateEvaluationCounters() {
    // Contar todas las evaluaciones en la página
    const allEvaluations = document.querySelectorAll('.evaluation-section');
    const counts = { bien: 0, regular: 0, mal: 0, pendiente: 0 };
    
    allEvaluations.forEach(section => {
        const activeBtn = section.querySelector('.btn-success, .btn-warning, .btn-danger, .btn-secondary:not(.btn-outline-secondary)');
        if (activeBtn) {
            const evaluation = activeBtn.getAttribute('data-evaluation');
            counts[evaluation]++;
        } else {
            counts.pendiente++; // Si no hay botón activo, está pendiente
        }
    });
    
    // Actualizar contadores en el resumen
    document.getElementById('goodCount').textContent = counts.bien;
    document.getElementById('regularCount').textContent = counts.regular;
    document.getElementById('badCount').textContent = counts.mal;
    document.getElementById('pendingCount').textContent = counts.pendiente;
}

// Variables para intercambio de preguntas
let selectedNewQuestionId = null;
let currentStudentQuestionId = null;

// Función de prueba para verificar que JavaScript funciona
console.log('JavaScript cargado correctamente');
console.log('URLs disponibles:', URLS);

// Funciones para intercambio de preguntas (ya incluidas en DOMContentLoaded principal)

function openChangeQuestionModal(btn) {
    console.log('openChangeQuestionModal called with btn:', btn);
    
    currentStudentQuestionId = btn.getAttribute('data-student-question-id');
    const groupId = btn.getAttribute('data-group-id');
    const currentQuestionId = btn.getAttribute('data-current-question-id');
    
    console.log('Modal data:', {currentStudentQuestionId, groupId, currentQuestionId});
    
    // Encontrar el texto de la pregunta actual
    const questionItem = btn.closest('.question-item');
    const currentQuestionElement = questionItem.querySelector('p');
    const currentQuestionText = currentQuestionElement ? currentQuestionElement.textContent : 'Pregunta no encontrada';
    
    console.log('Current question text:', currentQuestionText);
    
    // Mostrar pregunta actual en el modal
    const currentQuestionTextElement = document.getElementById('currentQuestionText');
    if (currentQuestionTextElement) {
        currentQuestionTextElement.textContent = currentQuestionText;
        console.log('Set current question text in modal');
    } else {
        console.error('currentQuestionText element not found!');
    }
    
    // Resetear selección
    selectedNewQuestionId = null;
    const confirmBtn = document.getElementById('confirmExchangeBtn');
    if (confirmBtn) {
        confirmBtn.disabled = true;
        console.log('Disabled confirm button');
    } else {
        console.error('confirmExchangeBtn element not found!');
    }
    
    // Cargar preguntas disponibles
    loadAvailableQuestions(groupId, currentQuestionId);
    
    // Mostrar modal (usando Bootstrap 4 JavaScript nativo)
    const modal = document.getElementById('changeQuestionModal');
    if (modal) {
        console.log('Showing modal...');
        // Intentar con jQuery primero, si no está disponible usar Bootstrap nativo
        if (typeof $ !== 'undefined' && $.fn.modal) {
            $('#changeQuestionModal').modal('show');
        } else if (typeof bootstrap !== 'undefined') {
            const bsModal = new bootstrap.Modal(modal);
            bsModal.show();
        } else {
            // Fallback: mostrar el modal manualmente
            modal.classList.add('show');
            modal.style.display = 'block';
            modal.setAttribute('aria-modal', 'true');
            modal.setAttribute('role', 'dialog');
            // Agregar backdrop
            const backdrop = document.createElement('div');
            backdrop.className = 'modal-backdrop fade show';
            document.body.appendChild(backdrop);
            document.body.classList.add('modal-open');
        }
    } else {
        console.error('Modal element not found!');
    }
}

function loadAvailableQuestions(groupId, currentQuestionId) {
    const container = document.getElementById('availableQuestionsContainer');
    container.innerHTML = `
        <div class="text-center">
            <div class="spinner-border" role="status">
                <span class="sr-only">Cargando...</span>
            </div>
            <p class="mt-2">Cargando preguntas disponibles...</p>
        </div>
    `;
    
    const url = URLS.getAvailableQuestions + '?' + 
                `group_id=${groupId}&current_question_id=${currentQuestionId}`;
    
    fetch(url)
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                displayAvailableQuestions(data.available_questions);
            } else {
                container.innerHTML = `
                    <div class="alert alert-danger">
                        <i class="fas fa-exclamation-triangle"></i> 
                        Error al cargar preguntas: ${data.error}
                    </div>
                `;
            }
        })
        .catch(error => {
            console.error('Error:', error);
            container.innerHTML = `
                <div class="alert alert-danger">
                    <i class="fas fa-exclamation-triangle"></i> 
                    Error de conexión al cargar preguntas.
                </div>
            `;
        });
}

function displayAvailableQuestions(questions) {
    const container = document.getElementById('availableQuestionsContainer');
    
    if (questions.length === 0) {
        container.innerHTML = `
            <div class="alert alert-warning">
                <i class="fas fa-info-circle"></i> 
                No hay preguntas disponibles para intercambio en este grupo.
            </div>
        `;
        return;
    }
    
    let html = '<div class="list-group" style="max-height: 400px; overflow-y: auto;">';
    
    questions.forEach(question => {
        html += `
            <label class="list-group-item list-group-item-action" style="cursor: pointer;">
                <div class="d-flex align-items-start">
                    <input type="radio" name="newQuestionRadio" value="${question.id}" class="mr-3 mt-1">
                    <div class="flex-grow-1">
                        <div class="mb-1">
                            <strong>${question.question_text}</strong>
                        </div>
                        <small class="text-muted">
                            <i class="fas fa-tag"></i> ${question.topic_name}
                            ${question.difficulty ? ' | ' + question.difficulty : ''}
                        </small>
                    </div>
                </div>
            </label>
        `;
    });
    
    html += '</div>';
    container.innerHTML = html;
}

function exchangeQuestion(studentQuestionId, newQuestionId) {
    console.log('exchangeQuestion called with:', { studentQuestionId, newQuestionId });
    
    // Verificar token CSRF
    const csrfToken = document.querySelector('[name=csrfmiddlewaretoken]');
    if (!csrfToken) {
        console.error('CSRF token not found!');
        alert('Error: Token de seguridad no encontrado. Recarga la página.');
        return;
    }
    
    const formData = new FormData();
    formData.append('student_question_id', studentQuestionId);
    formData.append('new_question_id', newQuestionId);
    formData.append('csrfmiddlewaretoken', csrfToken.value);
    
    console.log('FormData prepared:', {
        student_question_id: studentQuestionId,
        new_question_id: newQuestionId,
        csrf: csrfToken.value ? 'present' : 'missing'
    });
    
    // Deshabilitar botón durante el proceso
    const confirmBtn = document.getElementById('confirmExchangeBtn');
    confirmBtn.disabled = true;
    confirmBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Cambiando...';
    
    console.log('Sending POST to:', URLS.exchangeQuestion);
    
    fetch(URLS.exchangeQuestion, {
        method: 'POST',
        body: formData,
        headers: {
            'X-Requested-With': 'XMLHttpRequest'
        }
    })
    .then(response => {
        console.log('Response received:', response.status, response.statusText);
        if (!response.ok) {
            throw new Error(`HTTP ${response.status}: ${response.statusText}`);
        }
        return response.json();
    })
    .then(data => {
        console.log('Response data:', data);
        if (data.success) {
            // Mostrar mensaje de éxito
            const alertHtml = `
                <div class="alert alert-success alert-dismissible fade show">
                    <i class="fas fa-check"></i> ${data.message}
                    <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
                </div>
            `;
            
            // Cerrar modal con Bootstrap 5
            const modal = document.getElementById('changeQuestionModal');
            if (modal) {
                // Usar Bootstrap 5 nativo
                if (typeof bootstrap !== 'undefined') {
                    const bsModal = bootstrap.Modal.getInstance(modal) || new bootstrap.Modal(modal);
                    bsModal.hide();
                } else if (typeof $ !== 'undefined') {
                    // Fallback para jQuery con Bootstrap 5
                    const modalInstance = bootstrap.Modal.getOrCreateInstance(modal);
                    modalInstance.hide();
                } else {
                    // Fallback manual
                    modal.classList.remove('show');
                    modal.style.display = 'none';
                    modal.setAttribute('aria-hidden', 'true');
                    // Remover backdrop si existe
                    const backdrop = document.querySelector('.modal-backdrop');
                    if (backdrop) {
                        backdrop.remove();
                    }
                    document.body.classList.remove('modal-open');
                }
            }
            
            // Mostrar alerta y recargar página
            document.body.insertAdjacentHTML('afterbegin', alertHtml);
            
            // Recargar página para mostrar los cambios
            setTimeout(() => location.reload(), 1500);
        } else {
            // Mostrar error
            const errorHtml = `
                <div class="alert alert-danger mt-3">
                    <i class="fas fa-exclamation-triangle"></i> ${data.error}
                </div>
            `;
            document.getElementById('availableQuestionsContainer').insertAdjacentHTML('afterend', errorHtml);
            
            // Rehabilitar botón
            confirmBtn.disabled = false;
            confirmBtn.innerHTML = '<i class="fas fa-check"></i> Confirmar Cambio';
        }
    })
    .catch(error => {
        console.error('Error in exchangeQuestion:', error);
        
        // Mostrar error más detallado
        let errorMessage = 'Error de conexión al intercambiar pregunta.';
        if (error.message) {
            errorMessage += ` Detalle: ${error.message}`;
        }
        
        alert(errorMessage);
        
        // También mostrar en el modal si está abierto
        const errorDiv = document.createElement('div');
        errorDiv.className = 'alert alert-danger mt-3';
        errorDiv.innerHTML = `<i class="fas fa-exclamation-triangle"></i> ${errorMessage}`;
        
        const container = document.getElementById('availableQuestionsContainer');
        if (container) {
            container.parentNode.insertBefore(errorDiv, container.nextSibling);
            setTimeout(() => errorDiv.remove(), 5000);
        }
        
        // Rehabilitar botón
        confirmBtn.disabled = false;
        confirmBtn.innerHTML = '<i class="fas fa-check"></i> Confirmar Cambio';
    });
}

// Funciones globales para compatibilidad
function prevQuestion() {
    navigatePrevious();
}

function nextQuestion() {
    navigateNext();
}

</script>

{% endblock %}

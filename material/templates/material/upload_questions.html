{% extends 'material/base.html' %}
{% load static %}

{% block content %}
<div class="container {% if dark_mode %}bg-dark text-light{% else %}bg-light{% endif %}" style="min-height: 100vh; padding: 20px;">
    <h1 class="{% if dark_mode %}text-light{% else %}text-dark{% endif %}">Subir Preguntas</h1>

    <!-- Mensajes -->
    {% if messages %}
        {% for message in messages %}
            <div class="alert {% if message.tags == 'error' %}alert-danger{% else %}alert-success{% endif %}">
                {{ message }}
            </div>
        {% endfor %}
    {% endif %}

    <!-- Pestañas -->
    <ul class="nav nav-tabs mb-4" id="uploadTabs" role="tablist">
        <li class="nav-item">
            <a class="nav-link active" id="single-tab" data-toggle="tab" href="#single" role="tab">Individual</a>
        </li>
        <li class="nav-item">
            <a class="nav-link" id="batch-tab" data-toggle="tab" href="#batch" role="tab">Lote (CSV/TXT)</a>
        </li>
    </ul>

    <!-- Contenido de pestañas -->
    <div class="tab-content">
        <!-- Pestaña Individual -->
        <div class="tab-pane fade show active" id="single" role="tabpanel">
            <form method="post" enctype="multipart/form-data" id="singleForm">
                {% csrf_token %}
                <div class="form-group">
                    <label for="{{ form.subject.id_for_label }}">Materia</label>
                    <div class="input-group">
                        {{ form.subject }}
                        <div class="input-group-append">
                            <button class="btn btn-outline-secondary" type="button" data-toggle="modal" data-target="#newTopicModal">
                                <i class="fas fa-plus"></i> Nuevo Tema
                            </button>
                        </div>
                    </div>
                </div>

                <div class="row">
                    <div class="col-md-6">
                        <div class="form-group">
                            <label for="{{ form.topic.id_for_label }}">Tema Principal</label>
                            <div class="input-group">
                                {{ form.topic }}
                                <div class="input-group-append">
                                    <button class="btn btn-outline-secondary" type="button" id="addTopicBtn" disabled>
                                        <i class="fas fa-plus"></i>
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-6">
                        <div class="form-group">
                            <label for="{{ form.subtopic.id_for_label }}">Subtema</label>
                            <div class="input-group">
                                {{ form.subtopic }}
                                <div class="input-group-append">
                                    <button class="btn btn-outline-secondary" type="button" id="addSubtopicBtn" disabled>
                                        <i class="fas fa-plus"></i>
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Resto del formulario existente -->
                <div class="form-group">
                    <label for="{{ form.question_text.id_for_label }}">Pregunta</label>
                    {{ form.question_text }}
                </div>

                <div class="form-group">
                    <label for="{{ form.question_image.id_for_label }}">Imagen de Pregunta</label>
                    {{ form.question_image }}
                    <div id="questionImagePreview" class="mt-2" style="max-width: 300px;"></div>
                </div>

                <div class="form-group">
                    <label for="{{ form.answer_text.id_for_label }}">Respuesta</label>
                    {{ form.answer_text }}
                </div>

                <div class="form-group">
                    <label for="{{ form.answer_image.id_for_label }}">Imagen de Respuesta</label>
                    {{ form.answer_image }}
                    <div id="answerImagePreview" class="mt-2" style="max-width: 300px;"></div>
                </div>

                <div class="row">
                    <div class="col-md-4">
                        <div class="form-group">
                            <label for="{{ form.unit.id_for_label }}">Unidad</label>
                            {{ form.unit }}
                        </div>
                    </div>
                    <div class="col-md-4">
                        <div class="form-group">
                            <label for="{{ form.reference_book.id_for_label }}">Libro de Referencia</label>
                            {{ form.reference_book }}
                        </div>
                    </div>
                    <div class="col-md-2">
                        <div class="form-group">
                            <label for="{{ form.source_page.id_for_label }}">Página</label>
                            {{ form.source_page }}
                        </div>
                    </div>
                    <div class="col-md-2">
                        <div class="form-group">
                            <label for="{{ form.chapter.id_for_label }}">Capítulo</label>
                            {{ form.chapter }}
                        </div>
                    </div>
                </div>

                <button type="submit" class="btn btn-primary">Guardar Pregunta</button>
            </form>
        </div>

        <!-- Pestaña Lote -->
        <div class="tab-pane fade" id="batch" role="tabpanel">
            <form method="post" enctype="multipart/form-data" id="batchForm">
                {% csrf_token %}
                <div class="form-group">
                    <label for="batchFile">Subir Archivo</label>
                    <input type="file" class="form-control-file" id="batchFile" name="file" accept=".csv,.txt">
                    <small class="form-text text-muted">Formatos soportados: CSV o TXT</small>
                </div>

                <div class="mt-3">
                    <h5>Plantillas de Ejemplo:</h5>
                    <div class="btn-group">
                        <a href="{% url 'material:download_template' format='csv' %}" class="btn btn-outline-secondary">Descargar CSV</a>
                        <a href="{% url 'material:download_template' format='txt' %}" class="btn btn-outline-secondary">Descargar TXT</a>
                    </div>
                </div>

                <button type="submit" class="btn btn-primary mt-3">Subir Archivo</button>
            </form>
        </div>
    </div>

    <!-- Modal para nuevo Tema -->
    <div class="modal fade" id="newTopicModal" tabindex="-1" role="dialog" aria-labelledby="newTopicModalLabel" aria-hidden="true">
        <div class="modal-dialog" role="document">
            <div class="modal-content {% if dark_mode %}bg-dark text-light{% else %}bg-light{% endif %}">
                <div class="modal-header">
                    <h5 class="modal-title" id="newTopicModalLabel">Agregar Nuevo Tema</h5>
                    <button type="button" class="close {% if dark_mode %}text-light{% else %}text-dark{% endif %}" data-dismiss="modal" aria-label="Close">
                        <span aria-hidden="true">&times;</span>
                    </button>
                </div>
                <div class="modal-body">
                    <form id="newTopicForm">
                        <div class="form-group">
                            <label for="newTopicName">Nombre del Tema</label>
                            <input type="text" class="form-control {% if dark_mode %}bg-secondary text-light{% else %}bg-white{% endif %}" id="newTopicName" required>
                        </div>
                        <div class="form-group">
                            <label for="newTopicSubject">Materia</label>
                            <select class="form-control {% if dark_mode %}bg-secondary text-light{% else %}bg-white{% endif %}" id="newTopicSubject" required>
                                <option value="">Seleccione una materia</option>
                                {% for subject in form.subject.field.queryset %}
                                    <option value="{{ subject.id }}">{{ subject.name }}</option>
                                {% endfor %}
                            </select>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-dismiss="modal">Cancelar</button>
                    <button type="button" class="btn btn-primary" id="saveNewTopic">Guardar</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal para nuevo Subtema -->
    <div class="modal fade" id="newSubtopicModal" tabindex="-1" role="dialog" aria-labelledby="newSubtopicModalLabel" aria-hidden="true">
        <div class="modal-dialog" role="document">
            <div class="modal-content {% if dark_mode %}bg-dark text-light{% else %}bg-light{% endif %}">
                <div class="modal-header">
                    <h5 class="modal-title" id="newSubtopicModalLabel">Agregar Nuevo Subtema</h5>
                    <button type="button" class="close {% if dark_mode %}text-light{% else %}text-dark{% endif %}" data-dismiss="modal" aria-label="Close">
                        <span aria-hidden="true">&times;</span>
                    </button>
                </div>
                <div class="modal-body">
                    <form id="newSubtopicForm">
                        <div class="form-group">
                            <label for="newSubtopicName">Nombre del Subtema</label>
                            <input type="text" class="form-control {% if dark_mode %}bg-secondary text-light{% else %}bg-white{% endif %}" id="newSubtopicName" required>
                        </div>
                        <div class="form-group">
                            <label for="newSubtopicTopic">Tema Principal</label>
                            <select class="form-control {% if dark_mode %}bg-secondary text-light{% else %}bg-white{% endif %}" id="newSubtopicTopic" required>
                                <option value="">Seleccione un tema primero</option>
                            </select>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-dismiss="modal">Cancelar</button>
                    <button type="button" class="btn btn-primary" id="saveNewSubtopic">Guardar</button>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Scripts -->
<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
<script>
$(document).ready(function() {
    // Previsualización de imágenes
    function handleImagePreview(input, previewId) {
        if (input.files && input.files[0]) {
            const reader = new FileReader();
            reader.onload = function(e) {
                $(previewId).html(`<img src="${e.target.result}" class="img-fluid rounded border">`);
            }
            reader.readAsDataURL(input.files[0]);
        }
    }

    $('#{{ form.question_image.id_for_label }}').change(function() {
        handleImagePreview(this, '#questionImagePreview');
    });

    $('#{{ form.answer_image.id_for_label }}').change(function() {
        handleImagePreview(this, '#answerImagePreview');
    });

    // Dinámica de topic/subtopic
    $('#{{ form.subject.id_for_label }}').change(function() {
        const subjectId = $(this).val();
        if (subjectId) {
            $.ajax({
                url: '{% url "material:get_topics" %}',
                data: { 'subject_id': subjectId },
                success: function(data) {
                    let options = '<option value="">Seleccione un tema</option>';
                    data.forEach(function(topic) {
                        options += `<option value="${topic.id}">${topic.name}</option>`;
                    });
                    $('#{{ form.topic.id_for_label }}').html(options).prop('disabled', false);
                    $('#{{ form.subtopic.id_for_label }}').html('<option value="">Seleccione un tema primero</option>').prop('disabled', true);
                    $('#addTopicBtn').prop('disabled', false);
                }
            });
        } else {
            $('#{{ form.topic.id_for_label }}').html('<option value="">Seleccione una materia primero</option>').prop('disabled', true);
            $('#{{ form.subtopic.id_for_label }}').html('<option value="">Seleccione un tema primero</option>').prop('disabled', true);
            $('#addTopicBtn').prop('disabled', true);
        }
    });

    $('#{{ form.topic.id_for_label }}').change(function() {
        const topicId = $(this).val();
        if (topicId) {
            $.ajax({
                url: '{% url "material:get_subtopics" %}',
                data: { 'topic_id': topicId },
                success: function(data) {
                    let options = '<option value="">Sin subtema</option>';
                    data.forEach(function(subtopic) {
                        options += `<option value="${subtopic.id}">${subtopic.name}</option>`;
                    });
                    $('#{{ form.subtopic.id_for_label }}').html(options).prop('disabled', false);
                    $('#addSubtopicBtn').prop('disabled', false);
                    
                    // Actualizar select en modal de subtema
                    $('#newSubtopicTopic').html('<option value="">Seleccione un tema</option>');
                    data.forEach(function(topic) {
                        $('#newSubtopicTopic').append(`<option value="${topic.id}">${topic.name}</option>`);
                    });
                }
            });
        } else {
            $('#{{ form.subtopic.id_for_label }}').html('<option value="">Seleccione un tema primero</option>').prop('disabled', true);
            $('#addSubtopicBtn').prop('disabled', true);
        }
    });

    // Manejo de modales
    $('#addTopicBtn').click(function() {
        const subjectId = $('#{{ form.subject.id_for_label }}').val();
        if (!subjectId) {
            Swal.fire({
                icon: 'warning',
                title: 'Seleccione una materia primero',
                text: 'Debe seleccionar una materia antes de agregar un nuevo tema'
            });
            return;
        }
        $('#newTopicSubject').val(subjectId);
        $('#newTopicModal').modal('show');
    });

    $('#addSubtopicBtn').click(function() {
        const topicId = $('#{{ form.topic.id_for_label }}').val();
        if (!topicId) {
            Swal.fire({
                icon: 'warning',
                title: 'Seleccione un tema primero',
                text: 'Debe seleccionar un tema antes de agregar un nuevo subtema'
            });
            return;
        }
        
        // Cargar temas disponibles para el subtema
        const subjectId = $('#{{ form.subject.id_for_label }}').val();
        $.ajax({
            url: '{% url "material:get_topics" %}',
            data: { 'subject_id': subjectId },
            success: function(data) {
                let options = '<option value="">Seleccione un tema</option>';
                data.forEach(function(topic) {
                    options += `<option value="${topic.id}" ${topic.id == topicId ? 'selected' : ''}>${topic.name}</option>`;
                });
                $('#newSubtopicTopic').html(options);
                $('#newSubtopicModal').modal('show');
            }
        });
    });

    // Guardar nuevo Tema
    $('#saveNewTopic').click(function() {
        const name = $('#newTopicName').val();
        const subjectId = $('#newTopicSubject').val();
        
        if (!name || !subjectId) {
            Swal.fire({
                icon: 'error',
                title: 'Campos incompletos',
                text: 'Debe completar todos los campos'
            });
            return;
        }

        $.ajax({
            url: '{% url "material:add_topic" %}',
            method: 'POST',
            data: {
                'name': name,
                'subject_id': subjectId,
                'csrfmiddlewaretoken': '{{ csrf_token }}'
            },
            success: function(response) {
                if (response.success) {
                    // Actualizar select de temas
                    let newOption = new Option(response.topic.name, response.topic.id, true, true);
                    $('#{{ form.topic.id_for_label }}').append(newOption).trigger('change');
                    
                    Swal.fire({
                        icon: 'success',
                        title: 'Tema agregado',
                        text: 'El nuevo tema se ha agregado correctamente'
                    });
                    
                    $('#newTopicModal').modal('hide');
                    $('#newTopicName').val('');
                } else {
                    Swal.fire({
                        icon: 'error',
                        title: 'Error',
                        text: response.error || 'Ocurrió un error al guardar el tema'
                    });
                }
            },
            error: function() {
                Swal.fire({
                    icon: 'error',
                    title: 'Error',
                    text: 'Ocurrió un error al comunicarse con el servidor'
                });
            }
        });
    });

    // Guardar nuevo Subtema
    $('#saveNewSubtopic').click(function() {
        const name = $('#newSubtopicName').val();
        const topicId = $('#newSubtopicTopic').val();
        
        if (!name || !topicId) {
            Swal.fire({
                icon: 'error',
                title: 'Campos incompletos',
                text: 'Debe completar todos los campos'
            });
            return;
        }

        $.ajax({
            url: '{% url "material:add_subtopic" %}',
            method: 'POST',
            data: {
                'name': name,
                'topic_id': topicId,
                'csrfmiddlewaretoken': '{{ csrf_token }}'
            },
            success: function(response) {
                if (response.success) {
                    // Actualizar select de subtemas
                    let newOption = new Option(response.subtopic.name, response.subtopic.id, true, true);
                    $('#{{ form.subtopic.id_for_label }}').append(newOption).trigger('change');
                    
                    Swal.fire({
                        icon: 'success',
                        title: 'Subtema agregado',
                        text: 'El nuevo subtema se ha agregado correctamente'
                    });
                    
                    $('#newSubtopicModal').modal('hide');
                    $('#newSubtopicName').val('');
                } else {
                    Swal.fire({
                        icon: 'error',
                        title: 'Error',
                        text: response.error || 'Ocurrió un error al guardar el subtema'
                    });
                }
            },
            error: function() {
                Swal.fire({
                    icon: 'error',
                    title: 'Error',
                    text: 'Ocurrió un error al comunicarse con el servidor'
                });
            }
        });
    });

    // Cambiar pestañas
    $('a[data-toggle="tab"]').on('shown.bs.tab', function(e) {
        localStorage.setItem('lastTab', $(e.target).attr('id'));
    });

    const lastTab = localStorage.getItem('lastTab');
    if (lastTab) {
        $(`#${lastTab}`).tab('show');
    }
});
</script>

<style>
    .nav-tabs .nav-link {
        color: {% if dark_mode %}#ffffff{% else %}#495057{% endif %};
        background-color: {% if dark_mode %}#343a40{% else %}#f8f9fa{% endif %};
    }
    .nav-tabs .nav-link.active {
        color: {% if dark_mode %}#000000{% else %}#495057{% endif %};
        background-color: {% if dark_mode %}#f8f9fa{% else %}#ffffff{% endif %};
    }
    
    .input-group-append .btn {
        border-radius: 0 .25rem .25rem 0;
    }
</style>
{% endblock %}